<div class="card !bg-white !shadow-xl !rounded-xl !p-6">
  <div class="p-inputgroup !flex !flex-col lg:!flex-row lg:!items-center lg:!justify-between !gap-4 !mb-8">
    <div class="!flex !flex-col md:!flex-row !gap-4 !items-start md:!items-center !w-full lg:!w-auto">
      <!-- Selector de tienda -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-1">Tienda:</label>
        <select
          [(ngModel)]="selectedStore"
          (change)="onStoreChange()"
          class="border border-gray-300 rounded px-3 py-2 min-w-[200px]"
        >
          <option *ngFor="let store of stores" [value]="store.value">
            {{ store.label }}
          </option>
        </select>
      </div>

      <!-- Selector de tipo de factura -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-1">Tipo:</label>
        <select
          [(ngModel)]="selectedInvoiceType"
          (change)="onInvoiceTypeChange()"
          class="border border-gray-300 rounded px-3 py-2"
        >
          <option *ngFor="let type of invoiceTypes" [value]="type.value">
            {{ type.label }}
          </option>
        </select>
      </div>

      <!-- Filtro de b√∫squeda -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-1">Filtrar:</label>
        <input
          type="text"
          pInputText
          placeholder="Buscar por ID, cliente/proveedor, item, anotaci√≥n o descripci√≥n"
          [(ngModel)]="filterValue"
          (input)="onFilterChange()"
          class="p-inputtext !border-2 !border-blue-700 !text-gray-800 !bg-white !placeholder-gray-400 hover:!bg-blue-50 !transition !font-medium !rounded-lg !px-4 !py-2 focus:!outline-none focus:!ring-2 focus:!ring-blue-400 !w-full md:!w-80 !shadow-sm"
        />
      </div>
    </div>

    <div class="!flex !gap-2 !flex-col md:!flex-row">
      <button
        pButton
        type="button"
        label="B√∫squeda Masiva"
        (click)="openMassiveSearchModal()"
        icon="pi pi-search"
        class="p-button-outlined !border-2 !border-green-600 !text-green-700 !bg-white hover:!bg-green-100 !transition !font-semibold !rounded-lg !px-6 !py-2 focus:!outline-none focus:!ring-2 focus:!ring-green-400 !shadow-sm !w-full md:!w-auto"
      ></button>
      
      <button
        pButton
        type="button"
        label="Actualizar nuevas facturas"
        (click)="refreshInvoices()"
        icon="pi pi-refresh"
        class="p-button-outlined !border-2 !border-blue-700 !text-blue-700 !bg-white hover:!bg-blue-100 !transition !font-semibold !rounded-lg !px-8 !py-2 focus:!outline-none focus:!ring-2 focus:!ring-blue-400 !shadow-sm !w-full md:!w-auto"
      ></button>
    </div>
  </div>
  <div *ngIf="loading" class="p-mb-2 !text-blue-700 !font-semibold">
    <p *ngIf="selectedInvoiceType !== '' && selectedStore !== ''">Descargando facturas...</p>
  </div>
  <div *ngIf="progress > 0" class="p-mb-2 !text-blue-700 !font-semibold">
    <p *ngIf="selectedInvoiceType !== '' && selectedStore !== ''">Progreso: {{ progress }} facturas descargadas.</p>
  </div>
  <div *ngIf="!loading && invoices.length === 0 && !updating" class="p-mb-2 !text-red-600 !font-semibold">
    <p>{{ selectedInvoiceType === '' || selectedStore === '' ? "Seleccione tienda y un tipo de factura para ver resultados." : "No se encontraron resultados para el filtro ingresado." }}</p>
  </div>
  <div *ngIf="selectedInvoiceType !== '' && selectedStore !== ''" class="table-container !overflow-x-auto !rounded-xl !border !border-gray-200 !bg-gray-50 !shadow-lg">
    <p-table
      [value]="invoices"
      [paginator]="true"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [lazy]="true"
      [loading]="loading"
      [responsiveLayout]="'scroll'"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} facturas"
      [rowsPerPageOptions]="[10, 25, 50]"
      (onLazyLoad)="loadInvoicesLazy($event)"
      class="!w-full custom-paginator"
    >
      <ng-template pTemplate="header">
        <tr class="!bg-blue-800 !text-white !text-sm">
          <th class="!px-6 !py-4 !font-bold !text-left !rounded-tl-xl">ID</th>
          <th class="!px-6 !py-4 !font-bold !text-left">
            {{ selectedInvoiceType === 'sales' ? 'Cliente' : 'Proveedor' }}
          </th>
          <th class="!px-6 !py-4 !font-bold !text-left">Fecha</th>
          <th class="!px-6 !py-4 !font-bold !text-left">
            {{ selectedInvoiceType === 'sales' ? 'Item' : 'Items' }}
          </th>
          <th class="!px-6 !py-4 !font-bold !text-left">Anotaci√≥n</th>
          <th class="!px-6 !py-4 !font-bold !text-left">Descripci√≥n</th>
          <th class="!px-6 !py-4 !font-bold !text-left !rounded-tr-xl">Acci√≥n</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-invoice>
        <tr class="!bg-white !border-b !border-gray-100 hover:!bg-blue-50 !transition !shadow-sm">
          <td class="!px-6 !py-4 !font-mono !font-bold !text-blue-900">{{ invoice.numberTemplate.number }}</td>
          <td class="!px-6 !py-4 !text-gray-900">
            {{ selectedInvoiceType === 'sales' ? invoice.client?.name : invoice.provider?.name }}
          </td>
          <td class="!px-6 !py-4 !text-gray-700">{{ invoice.date }}</td>
          <td class="!px-6 !py-4 !text-gray-700">
            <span *ngIf="selectedInvoiceType === 'sales'">
              {{ invoice.items[0]?.name }}
            </span>
            <span *ngIf="selectedInvoiceType === 'purchases'">
              <span *ngFor="let item of invoice.purchases?.items; let i = index">
                {{ item.name }}<span *ngIf="i < invoice.purchases.items.length - 1">, </span>
              </span>
            </span>
          </td>
          <td class="!px-6 !py-4 !text-gray-700">
            {{ invoice.anotation }}
          </td>
          <td class="!px-6 !py-4 !text-gray-700">
            <span *ngIf="selectedInvoiceType === 'sales'">
              <span *ngFor="let item of invoice.items; let i = index">
                {{ item.description }}<span *ngIf="i < invoice.items.length - 1">, </span>
              </span>
            </span>
            <span *ngIf="selectedInvoiceType === 'purchases'">
              <span *ngFor="let item of invoice.purchases?.items; let i = index">
                {{ item.description }}<span *ngIf="i < invoice.purchases.items.length - 1">, </span>
              </span>
            </span>
          </td>
          <td class="!px-6 !py-4">
            <button
              pButton
              type="button"
              label="Ver"
              (click)="selectedInvoiceType === 'sales' ? goToAlegra(invoice.id) : goToAlegraBills(invoice.id)"
              icon="pi pi-refresh"
              class="p-button-outlined !border-2 !border-blue-600 !text-blue-700 !bg-white hover:!bg-blue-100 !transition !font-semibold !rounded-xl !px-5 !py-2 focus:!outline-none focus:!ring-2 focus:!ring-blue-400"
            >
              <i class="fa fa-external-link-alt"></i>
            </button>
          </td>
        </tr>
      </ng-template>

    </p-table>
  </div>
</div>

<!-- Modal de B√∫squeda Masiva (HTML/CSS simple) -->
<div 
  *ngIf="showMassiveSearchModal" 
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  (click)="closeMassiveSearchModal()"
>
  <div 
    class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-90vh overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
      <h2 class="text-xl font-bold">üîç B√∫squeda Masiva de IMEIs</h2>
      <button 
        (click)="closeMassiveSearchModal()"
        class="text-white hover:text-gray-200 text-2xl font-bold"
      >
        √ó
      </button>
    </div>

    <!-- Content -->
    <div class="p-6 space-y-6">
      
      <!-- Instrucciones -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h4 class="text-blue-800 font-semibold mb-2">üìã Instrucciones:</h4>
        <ul class="text-blue-700 text-sm space-y-1">
          <li>‚Ä¢ Pega la lista de IMEIs separados por espacios o saltos de l√≠nea</li>
          <li>‚Ä¢ El sistema buscar√° en las descripciones y observaciones de los items</li>
          <li>‚Ä¢ Te mostrar√° cu√°les se encontraron y cu√°les no</li>
        </ul>
      </div>

      <!-- Textarea para IMEIs -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-2">Lista de IMEIs:</label>
        <textarea
          [(ngModel)]="massiveSearchText"
          placeholder="Ejemplo:&#10;864436073433626&#10;864436073031842&#10;864436072725063&#10;864436073386543"
          rows="6"
          class="border-2 border-gray-300 rounded-lg px-3 py-2 text-sm resize-none focus:border-blue-500 focus:outline-none"
        ></textarea>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="flex gap-2 justify-end">
        <button
          (click)="closeMassiveSearchModal()"
          class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition"
        >
          Cancelar
        </button>
        
        <button
          (click)="performMassiveSearch()"
          [disabled]="!massiveSearchText.trim() || massiveSearchLoading"
          class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
        >
          <span *ngIf="massiveSearchLoading">Buscando...</span>
          <span *ngIf="!massiveSearchLoading">üîç Buscar</span>
        </button>
      </div>

      <!-- Resultados -->
      <div *ngIf="massiveSearchResults" class="mt-6 border-t pt-6">
        <h4 class="text-lg font-semibold mb-4">üìä Resultados de la b√∫squeda:</h4>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <!-- IMEIs Encontrados -->
          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <h5 class="text-green-800 font-semibold mb-2">
              ‚úÖ Encontrados ({{ massiveSearchResults.found.length }})
            </h5>
            <div class="max-h-32 overflow-y-auto">
              <div *ngFor="let result of massiveSearchResults.found" class="text-green-700 text-sm mb-1">
                <span class="font-mono">{{ result.imei }}</span>
                <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">
                  ID: {{ result.invoiceId }}
                </span>
              </div>
            </div>
          </div>

          <!-- IMEIs No Encontrados -->
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h5 class="text-red-800 font-semibold mb-2">
              ‚ùå No encontrados ({{ massiveSearchResults.notFound.length }})
            </h5>
            <div class="max-h-32 overflow-y-auto">
              <div *ngFor="let imei of massiveSearchResults.notFound" class="text-red-700 text-sm font-mono">
                {{ imei }}
              </div>
            </div>
          </div>
        </div>

        <!-- Resumen -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-700">
            <strong>Total buscados:</strong> {{ massiveSearchResults.totalSearched }} |
            <strong>Facturas coincidentes:</strong> {{ massiveSearchResults.matchingInvoices.length }}
          </p>
        </div>

        <!-- Botones de acci√≥n para resultados -->
        <div class="flex gap-2 justify-end">
          <button
            (click)="applyMassiveSearchFilter()"
            [disabled]="massiveSearchResults.matchingInvoices.length === 0"
            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            ‚úÖ Aplicar Filtro
          </button>
          
          <button
            (click)="clearMassiveSearchFilter()"
            class="px-6 py-2 border border-gray-300 text-gray-700 bg-white hover:bg-gray-100 rounded-lg transition"
          >
            üßπ Limpiar y Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
