<div class="card !bg-white !shadow-xl !rounded-xl !p-6">
  <div class="p-inputgroup !flex !flex-col lg:!flex-row lg:!items-center lg:!justify-between !gap-4 !mb-8">
    <div class="!flex !flex-col md:!flex-row !gap-4 !items-start md:!items-center !w-full lg:!w-auto">
      <!-- Selector de tienda -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-1">Tienda:</label>
        <select
          [(ngModel)]="selectedStore"
          (change)="onStoreChange()"
          class="border border-gray-300 rounded px-3 py-2 min-w-[200px]"
        >
          <option *ngFor="let store of stores" [value]="store.value">
            {{ store.label }}
          </option>
        </select>
      </div>

      <!-- Selector de tipo de factura -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-1">Tipo:</label>
        <select
          [(ngModel)]="selectedInvoiceType"
          (change)="onInvoiceTypeChange()"
          class="border border-gray-300 rounded px-3 py-2"
        >
          <option *ngFor="let type of invoiceTypes" [value]="type.value">
            {{ type.label }}
          </option>
        </select>
      </div>

      <!-- Filtro de búsqueda -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700 mb-1">Filtrar:</label>
        <input
          type="text"
          pInputText
          placeholder="Buscar por ID, cliente/proveedor, item, anotación o descripción"
          [(ngModel)]="filterValue"
          (input)="onFilterChange()"
          class="p-inputtext !border-2 !border-blue-700 !text-gray-800 !bg-white !placeholder-gray-400 hover:!bg-blue-50 !transition !font-medium !rounded-lg !px-4 !py-2 focus:!outline-none focus:!ring-2 focus:!ring-blue-400 !w-full md:!w-80 !shadow-sm"
        />
      </div>
    </div>

    <button
      pButton
      type="button"
      label="Actualizar nuevas facturas"
      (click)="refreshInvoices()"
      icon="pi pi-refresh"
      class="p-button-outlined !border-2 !border-blue-700 !text-blue-700 !bg-white hover:!bg-blue-100 !transition !font-semibold !rounded-lg !px-8 !py-2 focus:!outline-none focus:!ring-2 focus:!ring-blue-400 !shadow-sm !w-full md:!w-auto"
    ></button>
  </div>
  <div *ngIf="loading" class="p-mb-2 !text-blue-700 !font-semibold">
    <p *ngIf="selectedInvoiceType !== '' && selectedStore !== ''">Descargando facturas...</p>
  </div>
  <div *ngIf="progress > 0" class="p-mb-2 !text-blue-700 !font-semibold">
    <p *ngIf="selectedInvoiceType !== '' && selectedStore !== ''">Progreso: {{ progress }} facturas descargadas.</p>
  </div>
  <div *ngIf="!loading && invoices.length === 0 && !updating" class="p-mb-2 !text-red-600 !font-semibold">
    <p>{{ selectedInvoiceType === '' || selectedStore === '' ? "Seleccione tienda y un tipo de factura para ver resultados." : "No se encontraron resultados para el filtro ingresado." }}</p>
  </div>
  <div *ngIf="selectedInvoiceType !== '' && selectedStore !== ''" class="table-container !overflow-x-auto !rounded-xl !border !border-gray-200 !bg-gray-50 !shadow-lg">
    <p-table
      [value]="invoices"
      [paginator]="true"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [lazy]="true"
      [loading]="loading"
      [responsiveLayout]="'scroll'"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} facturas"
      [rowsPerPageOptions]="[10, 25, 50]"
      (onLazyLoad)="loadInvoicesLazy($event)"
      class="!w-full custom-paginator"
    >
      <ng-template pTemplate="header">
        <tr class="!bg-blue-800 !text-white !text-sm">
          <th class="!px-6 !py-4 !font-bold !text-left !rounded-tl-xl">ID</th>
          <th class="!px-6 !py-4 !font-bold !text-left">
            {{ selectedInvoiceType === 'sales' ? 'Cliente' : 'Proveedor' }}
          </th>
          <th class="!px-6 !py-4 !font-bold !text-left">Fecha</th>
          <th class="!px-6 !py-4 !font-bold !text-left">
            {{ selectedInvoiceType === 'sales' ? 'Item' : 'Items' }}
          </th>
          <th class="!px-6 !py-4 !font-bold !text-left">Anotación</th>
          <th class="!px-6 !py-4 !font-bold !text-left">Descripción</th>
          <th class="!px-6 !py-4 !font-bold !text-left !rounded-tr-xl">Acción</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-invoice>
        <tr class="!bg-white !border-b !border-gray-100 hover:!bg-blue-50 !transition !shadow-sm">
          <td class="!px-6 !py-4 !font-mono !font-bold !text-blue-900">{{ invoice.numberTemplate.number }}</td>
          <td class="!px-6 !py-4 !text-gray-900">
            {{ selectedInvoiceType === 'sales' ? invoice.client?.name : invoice.provider?.name }}
          </td>
          <td class="!px-6 !py-4 !text-gray-700">{{ invoice.date }}</td>
          <td class="!px-6 !py-4 !text-gray-700">
            <span *ngIf="selectedInvoiceType === 'sales'">
              {{ invoice.items[0]?.name }}
            </span>
            <span *ngIf="selectedInvoiceType === 'purchases'">
              <span *ngFor="let item of invoice.purchases?.items; let i = index">
                {{ item.name }}<span *ngIf="i < invoice.purchases.items.length - 1">, </span>
              </span>
            </span>
          </td>
          <td class="!px-6 !py-4 !text-gray-700">
            {{ invoice.anotation }}
          </td>
          <td class="!px-6 !py-4 !text-gray-700">
            <span *ngIf="selectedInvoiceType === 'sales'">
              <span *ngFor="let item of invoice.items; let i = index">
                {{ item.description }}<span *ngIf="i < invoice.items.length - 1">, </span>
              </span>
            </span>
            <span *ngIf="selectedInvoiceType === 'purchases'">
              <span *ngFor="let item of invoice.purchases?.items; let i = index">
                {{ item.description }}<span *ngIf="i < invoice.purchases.items.length - 1">, </span>
              </span>
            </span>
          </td>
          <td class="!px-6 !py-4">
            <button
              pButton
              type="button"
              label="Ver"
              (click)="selectedInvoiceType === 'sales' ? goToAlegra(invoice.id) : goToAlegraBills(invoice.id)"
              icon="pi pi-refresh"
              class="p-button-outlined !border-2 !border-blue-600 !text-blue-700 !bg-white hover:!bg-blue-100 !transition !font-semibold !rounded-xl !px-5 !py-2 focus:!outline-none focus:!ring-2 focus:!ring-blue-400"
            >
              <i class="fa fa-external-link-alt"></i>
            </button>
          </td>
        </tr>
      </ng-template>

    </p-table>
  </div>
</div>
